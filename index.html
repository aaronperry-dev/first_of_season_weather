<!DOCTYPE html>
<html>
<head>
    <title>New England Fall Weather Map: County-level First Chill, Frost & Hard Freeze Dates</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Explore an interactive map of New England showing the median dates for the first fall chill (≤45°F), first frost (≤32°F), and first hard freeze (≤29°F) by county.">
    <meta name="keywords" content="New England, frost dates, hard freeze, fall chill, weather map, Leaflet map, meteorology, climatology, gardening, fall foliage, Massachusetts, Maine, Vermont, New Hampshire, Connecticut, Rhode Island">
    <meta name="author" content="Aaron Perry">
    <meta property="og:type" content="website">
    <meta property="og:title" content="New England Fall Weather Map">
    <meta property="og:description" content="Interactive map showing median dates for the first fall chill, frost, and hard freeze in New England.">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }
        .info-popup {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .info-popup h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .info-popup table {
            width: 100%;
        }
        .info-popup td {
             padding: 2px 5px;
             font-size: 0.9em;
             color: #555;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }
        /* Style for the dropdown layer selector */
        .layer-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000; /* Ensure it's above the map */
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .layer-selector select {
            border: none;
            background: transparent;
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
        }
        /* Style for the attribution */
        .attribution-credit {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 5px;
            font-size: 11px;
        }
        /* Style for the new description box */
        #description-box {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        #description-box h4 {
            margin: 0 0 5px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        #description-box p {
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* Larger touch targets for zoom controls */
        .leaflet-bar a {
            height: 35px !important;
            width: 35px !important;
            line-height: 35px !important;
        }

        /* --- Mobile Optimization --- */
        @media (max-width: 768px) {
            #description-box {
                position: relative;
                width: auto;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid #ccc;
            }
            .layer-selector {
                position: relative;
                width: auto;
                top: 0;
                right: 0;
                left: 0;
                z-index: 10;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid #ccc;
                text-align: center;
            }
            .legend {
                width: auto;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Dropdown for layer selection -->
<div class="layer-selector">
    <label for="layer-select"></label>
    <select id="layer-select">
        <option value="chill">First Fall Chill Dates</option>
        <option value="frost">First Frost Dates</option>
        <option value="freeze">First Hard Freeze Dates</option>
    </select>
</div>

<!-- Description Box -->
<div id="description-box">
    <!-- Content will be dynamically inserted here -->
</div>


<!-- Custom Attribution -->
<div class="attribution-credit">
    Map and data compiled and created by Aaron Perry - Aug 2025
</div>


<script>
    // Initialize the map, centered on New England
    var map = L.map('map', {
        center: [44.0, -70.0],
        zoom: 7,
        attributionControl: false, // Disable default attribution to use custom one
        tap: false, // Recommended for mobile to avoid conflicts
        zoomAnimation: false // Can improve performance on older devices
    });

    // Create a new pane for the city markers to ensure they are on top
    map.createPane('cityPane');
    map.getPane('cityPane').style.zIndex = 650;
    map.getPane('cityPane').style.pointerEvents = 'none'; // Allow clicks to pass through to layers below


    // Add a modern, clean base tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    L.control.attribution({prefix: false}).addTo(map);


    // --- Global variables for layers and data ---
    let frostLayer, freezeLayer, chillLayer;
    let frostData, freezeData, chillData;
    let currentLayer = 'chill'; // Keep track of the active layer

    // --- Thematic Color Ramps ---
    // Reversing the ramps so that earlier dates (lower DOY) get the more dramatic color.
    const chillColors = ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506'].reverse(); // YlOrBr
    const frostColors = ['#ffffd9','#edf8b1','#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8','#253494','#081d58'].reverse(); // YlGnBu
    const freezeColors = ['#f7fcfd','#e0ecf4','#bfd3e6','#9ebcda','#8c96c6','#8c6bb1','#88419d','#810f7c','#4d004b'].reverse(); // PuBu

    // --- Content for the Description Box ---
    const layerDescriptions = {
        chill: {
            title: "First Fall Chill",
            text: "This layer shows the median date of the first day in autumn where the temperature drops to 45°F or below.<br><br><i>Note that actual dates can vary within a county due to factors like elevation, proximity to the ocean, and other local conditions.</i>"
        },
        frost: {
            title: "First Frost",
            text: "This layer displays the median date of the first frost, when temperatures reach 32°F or lower.<br><br><i>Note that actual dates can vary within a county due to factors like elevation, proximity to the ocean, and other local conditions.</i>"
        },
        freeze: {
            title: "First Hard Freeze",
            text: "This layer indicates the median date of the first 'hard freeze,' defined as temperatures reaching 29°F or lower.<br><br><i>Note that actual dates can vary within a county due to factors like elevation, proximity to the ocean, and other local conditions.</i>"
        }
    };

    // --- Helper Functions ---

    // Function to update the description box content
    function updateDescriptionBox(layerType) {
        const descriptionBox = document.getElementById('description-box');
        const content = layerDescriptions[layerType];
        if (descriptionBox && content) {
            descriptionBox.innerHTML = `<h4>${content.title}</h4><p>${content.text}</p>`;
        }
    }

    // Function to convert Day of Year to "Mon Day" format
    function doyToMonthDay(doy) {
        if (doy === null || doy === undefined) return 'N/A';
        const date = new Date(new Date().getFullYear(), 0);
        date.setDate(doy);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Updated getColor function to accept a specific color ramp
    function getColor(doy, minDoy, maxDoy, colors) {
        if (doy === null || doy === undefined) return '#cccccc'; // Handle missing data
        const range = maxDoy - minDoy;
        if (range <= 0) return colors[0];
        const index = Math.min(Math.floor(((doy - minDoy) / range) * (colors.length - 1)), colors.length - 1);
        return colors[Math.max(0, index)] || '#cccccc';
    }

    // --- Function to create popup content ---
    function createPopupContent(properties, type) {
        let title, earliest, early, median, late, latest;

        if (type === 'frost') {
            title = "First Frost (MinT &le;32&deg;F)";
            earliest = doyToMonthDay(properties.first_frost_earliest);
            early = doyToMonthDay(properties.first_frost_early_10p);
            median = doyToMonthDay(properties.first_frost_median);
            late = doyToMonthDay(properties.first_frost_late_90p);
            latest = doyToMonthDay(properties.first_frost_latest);
        } else if (type === 'freeze') {
            title = "First Hard Freeze (MinT &le;29&deg;F)";
            earliest = doyToMonthDay(properties.first_hard_freeze_earliest);
            early = doyToMonthDay(properties.first_hard_freeze_early_10p);
            median = doyToMonthDay(properties.first_hard_freeze_median);
            late = doyToMonthDay(properties.first_hard_freeze_late_90p);
            latest = doyToMonthDay(properties.first_hard_freeze_latest);
        } else { // 'chill'
            title = "First Fall Chill (MinT &le;45&deg;F)";
            earliest = doyToMonthDay(properties.first_foliage_chill_earliest);
            early = doyToMonthDay(properties.first_foliage_chill_early_10p);
            median = doyToMonthDay(properties.first_foliage_chill_median);
            late = doyToMonthDay(properties.first_foliage_chill_late_90p);
            latest = doyToMonthDay(properties.first_foliage_chill_latest);
        }


        return `<div class="info-popup">
                    <h4>${properties.COUNTYNAME} County, ${properties.STATE}</h4>
                    <strong>${title} Statistics</strong>
                    <table>
                        <tr><td><strong>Earliest (10th Percentile):</strong></td><td>${earliest}</td></tr>
                        <tr><td><strong>Early&nbsp;&nbsp;&nbsp;(25th Percentile):</strong></td><td>${early}</td></tr>
                        <tr><td><strong>Median&nbsp;&nbsp;&nbsp;(50th Percentile):</strong></td><td>${median}</td></tr>
                        <tr><td><strong>Late&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(90th Percentile):</strong></td><td>${late}</td></tr>
                        <tr><td><strong>Latest&nbsp;&nbsp;&nbsp;(99th Percentile):</strong></td><td>${latest}</td></tr>
                    </table>
                </div>`;
    }

    // --- Legend Control ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info legend');
        this.update();
        return this._div;
    };
    legend.update = function (layerType) {
        let data, medianProperty, title, colors;
        
        if (layerType === 'freeze') {
            data = freezeData;
            medianProperty = 'first_hard_freeze_median';
            title = 'Median Freeze Dates';
            colors = freezeColors;
        } else if (layerType === 'frost') {
            data = frostData;
            medianProperty = 'first_frost_median';
            title = 'Median Frost Dates';
            colors = frostColors;
        } else { // 'chill'
            data = chillData;
            medianProperty = 'first_foliage_chill_median';
            title = 'Median Fall Chill Dates';
            colors = chillColors;
        }
        
        if (!data) {
            this._div.innerHTML = '<strong>Median Dates</strong><br>Loading data...';
            return;
        }

        const medianValues = data.features.map(f => f.properties[medianProperty]).filter(v => v != null);
        const minDoy = Math.min(...medianValues);
        const maxDoy = Math.max(...medianValues);
        
        const grades = [];
        const step = (maxDoy - minDoy) / 6;
        for (let i = 0; i < 6; i++) {
            grades.push(Math.round(minDoy + i * step));
        }

        let innerHTML = `<strong>${title}</strong><br>`;
        for (var i = 0; i < grades.length; i++) {
            const color = getColor(grades[i] + 1, minDoy, maxDoy, colors);
            innerHTML +=
                `<i style="background:${color}"></i> ` +
                doyToMonthDay(grades[i]) + (grades[i + 1] ? '&ndash;' + doyToMonthDay(grades[i + 1] - 1) + '<br>' : '+');
        }
        this._div.innerHTML = innerHTML;
    };
    legend.addTo(map);

    // --- City Data ---
    const cities = [
        { name: "Bridgeport", state: "CT", coords: [41.1670, -73.2048], rank: 1 },
        { name: "Stamford", state: "CT", coords: [41.0534, -73.5387], rank: 2 },
        { name: "Portland", state: "ME", coords: [43.6615, -70.2553], rank: 1 },
        { name: "Lewiston", state: "ME", coords: [44.1003, -70.2148], rank: 2 },
        { name: "Boston", state: "MA", coords: [42.3601, -71.0589], rank: 1 },
        { name: "Worcester", state: "MA", coords: [42.2626, -71.7981], rank: 2 },
        { name: "Manchester", state: "NH", coords: [42.9956, -71.4548], rank: 1 },
        { name: "Nashua", state: "NH", coords: [42.7654, -71.4676], rank: 2 },
        { name: "Providence", state: "RI", coords: [41.8240, -71.4128], rank: 1 },
        { name: "Cranston", state: "RI", coords: [41.7715, -71.4534], rank: 2 },
        { name: "Burlington", state: "VT", coords: [44.4759, -73.2121], rank: 1 },
        { name: "South Burlington", state: "VT", coords: [44.4684, -73.1732], rank: 2 }
    ];

    // --- Create City Markers and Manage Visibility ---
    var cityMarkersLayer = L.layerGroup();
    var allCityMarkers = [];

    cities.forEach(city => {
        var marker = L.circleMarker(city.coords, {
            radius: 5,
            fillColor: "black",
            color: "#FFF",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8,
            pane: 'cityPane'
        }).bindTooltip(city.name);
        // Store the marker and its rank in an object
        allCityMarkers.push({ marker: marker, rank: city.rank });
    });

    function updateCityVisibility() {
        var currentZoom = map.getZoom();
        cityMarkersLayer.clearLayers(); // Clear existing markers before adding new ones

        allCityMarkers.forEach(cityInfo => {
            // Show rank 1 cities at zoom 7 or higher
            if (cityInfo.rank === 1 && currentZoom >= 7) {
                cityMarkersLayer.addLayer(cityInfo.marker);
            }
            // Show rank 2 cities only at zoom 8 or higher
            else if (cityInfo.rank === 2 && currentZoom >= 8) {
                cityMarkersLayer.addLayer(cityInfo.marker);
            }
        });
    }

    cityMarkersLayer.addTo(map);
    map.on('zoomend', updateCityVisibility);


    // --- Load GeoJSON data and initialize map ---
    Promise.all([
        fetch('./data/first_frost_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_hardfreeze_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_fallchill_climo_counties_neweng.geojson').then(res => res.json())
    ]).then(([frostJson, freezeJson, chillJson]) => {
        frostData = frostJson;
        freezeData = freezeJson;
        chillData = chillJson;

        const frostMedianValues = frostData.features.map(f => f.properties.first_frost_median).filter(v => v != null);
        const frostMin = Math.min(...frostMedianValues);
        const frostMax = Math.max(...frostMedianValues);

        const freezeMedianValues = freezeData.features.map(f => f.properties.first_hard_freeze_median).filter(v => v != null);
        const freezeMin = Math.min(...freezeMedianValues);
        const freezeMax = Math.max(...freezeMedianValues);
        
        const chillMedianValues = chillData.features.map(f => f.properties.first_foliage_chill_median).filter(v => v != null);
        const chillMin = Math.min(...chillMedianValues);
        const chillMax = Math.max(...chillMedianValues);

        frostLayer = L.geoJson(frostData, {
            style: feature => ({
                fillColor: getColor(feature.properties.first_frost_median, frostMin, frostMax, frostColors),
                weight: 1, opacity: 1, color: 'black', dashArray: '0', fillOpacity: 0.8
            }),
            onEachFeature: (feature, layer) => layer.bindTooltip(createPopupContent(feature.properties, 'frost'))
        });

        freezeLayer = L.geoJson(freezeData, {
            style: feature => ({
                fillColor: getColor(feature.properties.first_hard_freeze_median, freezeMin, freezeMax, freezeColors),
                weight: 1, opacity: 1, color: 'black', dashArray: '0', fillOpacity: 0.8
            }),
            onEachFeature: (feature, layer) => layer.bindTooltip(createPopupContent(feature.properties, 'freeze'))
        });
        
        chillLayer = L.geoJson(chillData, {
            style: feature => ({
                fillColor: getColor(feature.properties.first_foliage_chill_median, chillMin, chillMax, chillColors),
                weight: 1, opacity: 1, color: 'black', dashArray: '0', fillOpacity: 0.8
            }),
            onEachFeature: (feature, layer) => layer.bindTooltip(createPopupContent(feature.properties, 'chill'))
        });

        // Add initial layer and update legend and description
        chillLayer.addTo(map);
        legend.update('chill');
        updateDescriptionBox('chill');
        updateCityVisibility(); // Initial call to set city visibility

    }).catch(error => console.error("Failed to load map data:", error));


    // --- Event Listener for the dropdown ---
    document.getElementById('layer-select').addEventListener('change', function(e) {
        const selectedLayer = e.target.value;

        // Remove current layer
        if (map.hasLayer(frostLayer)) map.removeLayer(frostLayer);
        if (map.hasLayer(freezeLayer)) map.removeLayer(freezeLayer);
        if (map.hasLayer(chillLayer)) map.removeLayer(chillLayer);
        

        // Add new layer and update legend and description
        if (selectedLayer === 'frost') {
            map.addLayer(frostLayer);
            legend.update('frost');
            updateDescriptionBox('frost');
        } else if (selectedLayer === 'freeze') {
            map.addLayer(freezeLayer);
            legend.update('freeze');
            updateDescriptionBox('freeze');
        } else if (selectedLayer === 'chill') {
            map.addLayer(chillLayer);
            legend.update('chill');
            updateDescriptionBox('chill');
        }

        currentLayer = selectedLayer;
    });

</script>

</body>
</html>
