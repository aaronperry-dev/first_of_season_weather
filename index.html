<!DOCTYPE html>
<html>
<head>
    <title>New England Fall Weather Map: County-level First Chill, Frost & Hard Freeze Dates</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Explore an interactive map of New England showing the median dates for the first fall chill (‚â§45¬∞F), first frost (‚â§32¬∞F), and first hard freeze (‚â§29¬∞F) by county.">
    <meta name="keywords" content="New England, frost dates, hard freeze, fall chill, weather map, Leaflet map, meteorology, climatology, gardening, fall foliage, Massachusetts, Maine, Vermont, New Hampshire, Connecticut, Rhode Island">
    <meta name="author" content="Aaron Perry">
    <meta property="og:type" content="website">
    <meta property="og:title" content="New England Fall Weather Map">
    <meta property="og:description" content="Interactive map showing median dates for the first fall chill, frost, and hard freeze in New England.">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            height: 100%;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        .info-popup {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .info-popup h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .info-popup table {
            width: 100%;
        }
        .info-popup td {
             padding: 2px 5px;
             font-size: 0.9em;
             color: #555;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }
        .layer-selector {
            padding: 5px 10px;
        }
        .layer-selector select {
            border: 1px solid #ccc;
            padding: 5px;
            background: white;
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
            width: 100%;
        }
        .attribution-credit {
            position: absolute;
            bottom: 5px;
            left: 90px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 5px;
            font-size: 11px;
        }
        #description-box {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        #description-box h4 {
            margin: 0 0 5px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        #description-box p {
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }
        .leaflet-bar a {
            height: 35px !important;
            width: 35px !important;
            line-height: 35px !important;
        }
        .city-label {
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #000;
            text-shadow: 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff;
        }
        .leaflet-control-custom a {
            font-size: 1.4em;
            text-align: center;
            cursor: pointer;
        }

        /* --- Desktop & Larger Screen Overrides --- */
        @media (min-width: 769px) {
            body {
                display: block; /* Revert to standard block layout */
            }
            #description-box {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1000;
                width: 280px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 5px;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-bottom: none;
            }
            .layer-selector {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 1000;
                background: white;
                border-radius: 5px;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-bottom: none;
            }
            .layer-selector select {
                border: none;
                background: transparent;
                width: auto;
            }
            .leaflet-top.leaflet-right .leaflet-control-layers {
                margin-top: 60px;
            }
        }
    </style>
</head>
<body>

<div id="description-box"></div>

<div class="layer-selector">
    <label for="layer-select"></label>
    <select id="layer-select">
        <option value="chill">First Fall Chill Dates</option>
        <option value="frost">First Frost Dates</option>
        <option value="freeze">First Hard Freeze Dates</option>
        <option value="snow">First Snowfall Dates</option>
    </select>
</div>

<div id="map"></div>

<div class="attribution-credit">
    Map and data compiled and created by Aaron Perry - Aug 2025
</div>


<script>
    // --- Basemap Definitions ---
    var lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO'
    });
    var darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO'
    });
    var terrainMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
     attribution: 'Tiles &copy; Esri'
    });

    // Initialize the map
    var map = L.map('map', {
        center: [44.0, -70.0],
        zoom: 7,
        attributionControl: false, 
        tap: false, 
        zoomAnimation: false,
        zoomControl: false,
        layers: [lightMap]
    });

    // --- Pane Management ---
    map.createPane('cityPane');
    map.getPane('cityPane').style.zIndex = 650;
    map.getPane('tooltipPane').style.zIndex = 700;

    // --- Controls ---
    L.control.attribution({prefix: false}).addTo(map);
    L.control.scale({ imperial: true, metric: false }).addTo(map);
    var baseMaps = { "Light": lightMap, "Dark": darkMap, "Terrain": terrainMap };
    L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);

    // --- Home Button Control ---
    L.Control.Custom = L.Control.extend({
        onAdd: function(map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            container.innerHTML = '<a href="#" title="Reset View">üè†</a>';
            container.onclick = function(e) {
                e.preventDefault();
                map.setView([44.0, -70.0], 7);
            }
            return container;
        },
        onRemove: function(map) {}
    });
    new L.Control.Custom({ position: 'bottomleft' }).addTo(map);

    // --- Global Variables ---
    let frostLayer, freezeLayer, chillLayer, snowLayer;
    let frostData, freezeData, chillData, snowData;
    let currentLayer = 'chill';
    let lastHoveredLayer = null;

    // --- Thematic Color Ramps ---
    const chillColors = ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506'].reverse();
    const frostColors = ['#ffffd9','#edf8b1','#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8','#253494','#081d58'].reverse();
    const freezeColors = ['#f7fcfd','#e0ecf4','#bfd3e6','#9ebcda','#8c96c6','#8c6bb1','#88419d','#810f7c','#4d004b'].reverse();
    const snowColors = ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c','#08306b'].reverse();

    // --- Content Definitions ---
    const layerDescriptions = {
        chill: { title: "First Fall Chill", text: "Median date of the first day where the temperature drops to 45¬∞F or below.<br><br><i>Note: Actual dates can vary within a county due to elevation, proximity to the ocean, and other local conditions.</i>" },
        frost: { title: "First Frost", text: "Median date of the first frost, when temperatures reach 32¬∞F or lower.<br><br><i>Note: Actual dates can vary within a county due to elevation, proximity to the ocean, and other local conditions.</i>" },
        freeze: { title: "First Hard Freeze", text: "Median date of the first 'hard freeze,' when temperatures reach 29¬∞F or lower.<br><br><i>Note: Actual dates can vary within a county due to elevation, proximity to the ocean, and other local conditions.</i>" },
        snow: { title: "First Snowfall", text: "Median date of the first snowfall, as measured by the first >=0.1\" of snowfall of the season.<br><br><i>Note: Actual dates can vary within a county due to elevation, proximity to the ocean, and other local conditions.</i>" }
    };

    // --- Helper Functions ---
    function updateDescriptionBox(layerType) {
        const content = layerDescriptions[layerType];
        document.getElementById('description-box').innerHTML = `<h4>${content.title}</h4><p>${content.text}</p>`;
    }

    function doyToMonthDay(doy) {
        if (doy == null) return 'N/A';
        const date = new Date(new Date().getFullYear(), 0);
        date.setDate(doy);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function getColor(doy, minDoy, maxDoy, colors) {
        if (doy == null) return '#cccccc';
        const range = maxDoy - minDoy;
        if (range <= 0) return colors[0];
        const index = Math.min(Math.floor(((doy - minDoy) / range) * (colors.length - 1)), colors.length - 1);
        return colors[Math.max(0, index)] || '#cccccc';
    }

    function createPopupContent(properties, type) {
        let title, earliest, early, median, late, latest;
        if (type === 'frost') {
            title = "First Frost (MinT &le;32&deg;F)";
            [earliest, early, median, late, latest] = [properties.first_frost_earliest, properties.first_frost_early_10p, properties.first_frost_median, properties.first_frost_late_90p, properties.first_frost_latest];
        } else if (type === 'freeze') {
            title = "First Hard Freeze (MinT &le;29&deg;F)";
            [earliest, early, median, late, latest] = [properties.first_hard_freeze_earliest, properties.first_hard_freeze_early_10p, properties.first_hard_freeze_median, properties.first_hard_freeze_late_90p, properties.first_hard_freeze_latest];
        } else if (type === 'snow') {
            title = "First Snowfall >= 0.1\"";
            [earliest, early, median, late, latest] = [properties.snow_earliest, properties.snow_early_10p, properties.snow_median, properties.snow_late_90p, properties.snow_latest];
        } else {
            title = "First Fall Chill (MinT &le;45&deg;F)";
            [earliest, early, median, late, latest] = [properties.first_foliage_chill_earliest, properties.first_foliage_chill_early_10p, properties.first_foliage_chill_median, properties.first_foliage_chill_late_90p, properties.first_foliage_chill_latest];
        }
        return `<div class="info-popup"><h4>${properties.COUNTYNAME} County, ${properties.STATE}</h4><strong>${title} Statistics</strong><table>
                        <tr><td><strong>Earliest (10th Percentile):</strong></td><td>${doyToMonthDay(earliest)}</td></tr>
                        <tr><td><strong>Early&nbsp;&nbsp;&nbsp;(25th Percentile):</strong></td><td>${doyToMonthDay(early)}</td></tr>
                        <tr><td><strong>Median&nbsp;&nbsp;&nbsp;(50th Percentile):</strong></td><td>${doyToMonthDay(median)}</td></tr>
                        <tr><td><strong>Late&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(90th Percentile):</strong></td><td>${doyToMonthDay(late)}</td></tr>
                        <tr><td><strong>Latest&nbsp;&nbsp;&nbsp;(99th Percentile):</strong></td><td>${doyToMonthDay(latest)}</td></tr>
                    </table></div>`;
    }

    // --- Legend Control ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map) { this._div = L.DomUtil.create('div', 'info legend'); this.update(); return this._div; };
    legend.update = function(layerType) {
        let data, medianProperty, title, colors;
        if (layerType === 'freeze') { [data, medianProperty, title, colors] = [freezeData, 'first_hard_freeze_median', 'Median Freeze Dates', freezeColors]; }
        else if (layerType === 'frost') { [data, medianProperty, title, colors] = [frostData, 'first_frost_median', 'Median Frost Dates', frostColors]; }
        else if (layerType === 'snow') { [data, medianProperty, title, colors] = [snowData, 'snow_median', 'Median Snowfall Dates', snowColors]; }
        else { [data, medianProperty, title, colors] = [chillData, 'first_foliage_chill_median', 'Median Fall Chill Dates', chillColors]; }
        
        if (!data) { this._div.innerHTML = '<strong>Median Dates</strong><br>Loading...'; return; }

        const medianValues = data.features.map(f => f.properties[medianProperty]).filter(v => v != null);
        const [minDoy, maxDoy] = [Math.min(...medianValues), Math.max(...medianValues)];
        const grades = Array.from({length: 6}, (_, i) => Math.round(minDoy + i * (maxDoy - minDoy) / 6));

        let innerHTML = `<strong>${title}</strong><br>`;
        grades.forEach((grade, i) => {
            innerHTML += `<i style="background:${getColor(grade + 1, minDoy, maxDoy, colors)}"></i> ${doyToMonthDay(grade)}${(grades[i + 1] ? '&ndash;' + doyToMonthDay(grades[i + 1] - 1) + '<br>' : '+')}`;
        });
        this._div.innerHTML = innerHTML;
    };
    legend.addTo(map);

    // --- City Data & Markers ---
    const cities = [
        { name: "Hartford", state: "CT", coords: [41.7658, -72.6734] }, { name: "Bridgeport", state: "CT", coords: [41.1670, -73.2048] },
        { name: "Augusta", state: "ME", coords: [44.3106, -69.7794] }, { name: "Portland", state: "ME", coords: [43.6615, -70.2553] },
        { name: "Boston", state: "MA", coords: [42.3601, -71.0589] }, { name: "Worcester", state: "MA", coords: [42.2626, -71.7981] },
        { name: "Concord", state: "NH", coords: [43.2081, -71.5376] }, { name: "Manchester", state: "NH", coords: [42.9956, -71.4548] },
        { name: "Providence", state: "RI", coords: [41.8240, -71.4128] }, { name: "Cranston", state: "RI", coords: [41.7715, -71.4534] },
        { name: "Montpelier", state: "VT", coords: [44.2601, -72.5754] }, { name: "Burlington", state: "VT", coords: [44.4759, -73.2121] }
    ];
    var cityMarkersLayer = L.layerGroup();
    cities.forEach(city => {
        var circle = L.circleMarker(city.coords, { radius: 5, fillColor: "black", color: "#FFF", weight: 1, opacity: 1, fillOpacity: 0.8, pane: 'cityPane' });
        var label = L.marker(city.coords, { icon: L.divIcon({ className: 'city-label', html: `&nbsp;&nbsp;${city.name}`, iconAnchor: [0, 8] }), pane: 'cityPane' });
        cityMarkersLayer.addLayer(L.layerGroup([circle, label]));
    });
    cityMarkersLayer.addTo(map);

    // --- GeoJSON Layer Events ---
    function onEachFeature(feature, layer) {
        let type = layer.options.dataType;
        layer.bindTooltip(createPopupContent(feature.properties, type), {pane: 'tooltipPane'});

        layer.on({
            mouseover: function(e) {
                var layer = e.target;
                layer.setStyle({ color: 'white', weight: 2.5 });
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
            },
            mouseout: function(e) {
                if (currentLayer === 'chill') chillLayer.resetStyle(e.target);
                if (currentLayer === 'frost') frostLayer.resetStyle(e.target);
                if (currentLayer === 'freeze') freezeLayer.resetStyle(e.target);
                if (currentLayer === 'snow') snowLayer.resetStyle(e.target);
            }
        });
    }

    // --- Load GeoJSON data and initialize map ---
    Promise.all([
        fetch('./data/first_frost_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_hardfreeze_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_fallchill_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_snowfall_climo_counties_neweng.geojson').then(res => res.json())
    ]).then(([frostJson, freezeJson, chillJson, snowJson]) => {
        [frostData, freezeData, chillData, snowData] = [frostJson, freezeJson, chillJson, snowJson];

        const frostMedianValues = frostData.features.map(f => f.properties.first_frost_median).filter(v => v != null);
        const [frostMin, frostMax] = [Math.min(...frostMedianValues), Math.max(...frostMedianValues)];

        const freezeMedianValues = freezeData.features.map(f => f.properties.first_hard_freeze_median).filter(v => v != null);
        const [freezeMin, freezeMax] = [Math.min(...freezeMedianValues), Math.max(...freezeMedianValues)];
        
        const chillMedianValues = chillData.features.map(f => f.properties.first_foliage_chill_median).filter(v => v != null);
        const [chillMin, chillMax] = [Math.min(...chillMedianValues), Math.max(...chillMedianValues)];

        const snowMedianValues = snowData.features.map(f => f.properties.snow_median).filter(v => v != null);
        const [snowMin, snowMax] = [Math.min(...snowMedianValues), Math.max(...snowMedianValues)];

        chillLayer = L.geoJson(chillData, {
            style: f => ({ fillColor: getColor(f.properties.first_foliage_chill_median, chillMin, chillMax, chillColors), weight: 1, opacity: 1, color: 'black', fillOpacity: 0.8 }),
            onEachFeature: onEachFeature, dataType: 'chill'
        });
        frostLayer = L.geoJson(frostData, {
            style: f => ({ fillColor: getColor(f.properties.first_frost_median, frostMin, frostMax, frostColors), weight: 1, opacity: 1, color: 'black', fillOpacity: 0.8 }),
            onEachFeature: onEachFeature, dataType: 'frost'
        });
        freezeLayer = L.geoJson(freezeData, {
            style: f => ({ fillColor: getColor(f.properties.first_hard_freeze_median, freezeMin, freezeMax, freezeColors), weight: 1, opacity: 1, color: 'black', fillOpacity: 0.8 }),
            onEachFeature: onEachFeature, dataType: 'freeze'
        });
        snowLayer = L.geoJson(snowData, {
            style: f => ({ fillColor: getColor(f.properties.snow_median, snowMin, snowMax, snowColors), weight: 1, opacity: 1, color: 'black', fillOpacity: 0.8 }),
            onEachFeature: onEachFeature, dataType: 'snow'
        });

        chillLayer.addTo(map);
        legend.update('chill');
        updateDescriptionBox('chill');

    }).catch(error => console.error("Failed to load map data:", error));

    // --- Dropdown Event Listener ---
    document.getElementById('layer-select').addEventListener('change', function(e) {
        currentLayer = e.target.value;
        if (map.hasLayer(frostLayer)) map.removeLayer(frostLayer);
        if (map.hasLayer(freezeLayer)) map.removeLayer(freezeLayer);
        if (map.hasLayer(chillLayer)) map.removeLayer(chillLayer);
        if (map.hasLayer(snowLayer)) map.removeLayer(snowLayer);
        
        if (currentLayer === 'frost') map.addLayer(frostLayer);
        else if (currentLayer === 'freeze') map.addLayer(freezeLayer);
        else if (currentLayer === 'snow') map.addLayer(snowLayer);
        else map.addLayer(chillLayer);
        
        legend.update(currentLayer);
        updateDescriptionBox(currentLayer);
    });
</script>

</body>
</html>
