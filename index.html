<!DOCTYPE html>
<html>
<head>
    <title>First Frost/Hard Freeze/Fall Chill Dates (by County) in New England</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }
        .info-popup {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .info-popup h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .info-popup table {
            width: 100%;
        }
        .info-popup td {
             padding: 2px 5px;
             font-size: 0.9em;
             color: #555;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        /* Style for the dropdown layer selector */
        .layer-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000; /* Ensure it's above the map */
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .layer-selector select {
            border: none;
            background: transparent;
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
        }
        /* Style for the attribution */
        .attribution-credit {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 5px;
            font-size: 11px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Dropdown for layer selection -->
<div class="layer-selector">
    <label for="layer-select"></label>
    <select id="layer-select">
        <option value="chill">First Fall Chill Dates</option>
        <option value="frost">First Frost Dates</option>
        <option value="freeze">First Hard Freeze Dates</option>
    </select>
</div>

<!-- Custom Attribution -->
<div class="attribution-credit">
    Map and data compiled and created by Aaron Perry - Aug 2025
</div>


<script>
    // Initialize the map, centered on New England
    var map = L.map('map', {
        center: [44.0, -70.0],
        zoom: 7,
        attributionControl: false // Disable default attribution to use custom one
    });

    // Add a modern, clean base tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    L.control.attribution({prefix: false}).addTo(map);


    // --- Global variables for layers and data ---
    let frostLayer, freezeLayer, chillLayer;
    let frostData, freezeData, chillData;
    let currentLayer = 'chill'; // Keep track of the active layer

    // --- Helper Functions ---

    // Function to convert Day of Year to "Mon Day" format
    function doyToMonthDay(doy) {
        if (doy === null || doy === undefined) return 'N/A';
        const date = new Date(new Date().getFullYear(), 0);
        date.setDate(doy);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Viridis color ramp
    const viridis = ['#440154', '#482878', '#3e4989', '#31688e', '#26828e', '#1f9e89', '#35b779', '#6ece58', '#b5de2b', '#fde725'];

    // Function to get color from Viridis ramp based on DOY and the data's range
    function getColor(doy, minDoy, maxDoy) {
        if (doy === null || doy === undefined) return '#cccccc'; // Handle missing data
        const range = maxDoy - minDoy;
        if (range <= 0) return viridis[0];
        const index = Math.min(Math.floor(((doy - minDoy) / range) * (viridis.length - 1)), viridis.length - 1);
        return viridis[Math.max(0, index)] || '#cccccc';
    }

    // --- Function to create popup content ---
    function createPopupContent(properties, type) {
        let title, earliest, early, median, late, latest;

        if (type === 'frost') {
            title = "First Frost (&le;32&deg;F)";
            earliest = doyToMonthDay(properties.first_frost_earliest);
            early = doyToMonthDay(properties.first_frost_early_10p);
            median = doyToMonthDay(properties.first_frost_median);
            late = doyToMonthDay(properties.first_frost_late_90p);
            latest = doyToMonthDay(properties.first_frost_latest);
        } else if (type === 'freeze') {
            title = "First Hard Freeze (&le;29&deg;F)";
            earliest = doyToMonthDay(properties.first_hard_freeze_earliest);
            early = doyToMonthDay(properties.first_hard_freeze_early_10p);
            median = doyToMonthDay(properties.first_hard_freeze_median);
            late = doyToMonthDay(properties.first_hard_freeze_late_90p);
            latest = doyToMonthDay(properties.first_hard_freeze_latest);
        } else { // 'chill'
            title = "First Fall Chill (&le;40&deg;F)";
            earliest = doyToMonthDay(properties.first_foliage_chill_earliest);
            early = doyToMonthDay(properties.first_foliage_chill_early_10p);
            median = doyToMonthDay(properties.first_foliage_chill_median);
            late = doyToMonthDay(properties.first_foliage_chill_late_90p);
            latest = doyToMonthDay(properties.first_foliage_chill_latest);
        }


        return `<div class="info-popup">
                    <h4>${properties.COUNTYNAME} County, ${properties.STATE}</h4>
                    <strong>${title} Statistics</strong>
                    <table>
                        <tr><td><strong>Earliest (p10):</strong></td><td>${earliest}</td></tr>
                        <tr><td><strong>Early&nbsp;&nbsp;&nbsp;(p25):</strong></td><td>${early}</td></tr>
                        <tr><td><strong>Median&nbsp;&nbsp;&nbsp;(p50):</strong></td><td>${median}</td></tr>
                        <tr><td><strong>Late&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(p90):</strong></td><td>${late}</td></tr>
                        <tr><td><strong>Latest&nbsp;&nbsp;&nbsp;(p99):</strong></td><td>${latest}</td></tr>
                    </table>
                </div>`;
    }

    // --- Legend Control ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info legend');
        this.update();
        return this._div;
    };
    legend.update = function (layerType) {
        let data, medianProperty, title;
        
        if (layerType === 'freeze') {
            data = freezeData;
            medianProperty = 'first_hard_freeze_median';
            title = 'Median Freeze Dates';
        } else if (layerType === 'frost') {
            data = frostData;
            medianProperty = 'first_frost_median';
            title = 'Median Frost Dates';
        } else { // 'chill'
            data = chillData;
            medianProperty = 'first_foliage_chill_median';
            title = 'Median Fall Chill Dates';
        }
        
        if (!data) {
            this._div.innerHTML = '<strong>Median Dates</strong><br>Loading data...';
            return;
        }

        const medianValues = data.features.map(f => f.properties[medianProperty]).filter(v => v != null);
        const minDoy = Math.min(...medianValues);
        const maxDoy = Math.max(...medianValues);
        
        const grades = [];
        const step = (maxDoy - minDoy) / 6;
        for (let i = 0; i < 6; i++) {
            grades.push(Math.round(minDoy + i * step));
        }

        let innerHTML = `<strong>${title}</strong><br>`;
        for (var i = 0; i < grades.length; i++) {
            const color = getColor(grades[i] + 1, minDoy, maxDoy);
            innerHTML +=
                `<i style="background:${color}"></i> ` +
                doyToMonthDay(grades[i]) + (grades[i + 1] ? '&ndash;' + doyToMonthDay(grades[i + 1] - 1) + '<br>' : '+');
        }
        this._div.innerHTML = innerHTML;
    };
    legend.addTo(map);


    // --- Load GeoJSON data and initialize map ---
    Promise.all([
        fetch('./data/first_frost_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_hardfreeze_climo_counties_neweng.geojson').then(res => res.json()),
        fetch('./data/first_fallchill_climo_counties_neweng.geojson').then(res => res.json())
    ]).then(([frostJson, freezeJson, chillJson]) => {
        frostData = frostJson;
        freezeData = freezeJson;
        chillData = chillJson;

        const frostMedianValues = frostData.features.map(f => f.properties.first_frost_median).filter(v => v != null);
        const frostMin = Math.min(...frostMedianValues);
        const frostMax = Math.max(...frostMedianValues);

        const freezeMedianValues = freezeData.features.map(f => f.properties.first_hard_freeze_median).filter(v => v != null);
        const freezeMin = Math.min(...freezeMedianValues);
        const freezeMax = Math.max(...freezeMedianValues);
        
        const chillMedianValues = chillData.features.map(f => f.properties.first_foliage_chill_median).filter(v => v != null);
        const chillMin = Math.min(...chillMedianValues);
        const chillMax = Math.max(...chillMedianValues);

        frostLayer = L.geoJson(frostData, {
            style: feature => ({
                fillColor: getColor(feature.properties.first_frost_median, frostMin, frostMax),
                weight: 1, opacity: 1, color: 'black', dashArray: '0', fillOpacity: 0.8
            }),
            onEachFeature: (feature, layer) => layer.bindTooltip(createPopupContent(feature.properties, 'frost'))
        });

        freezeLayer = L.geoJson(freezeData, {
            style: feature => ({
                fillColor: getColor(feature.properties.first_hard_freeze_median, freezeMin, freezeMax),
                weight: 1, opacity: 1, color: 'black', dashArray: '0', fillOpacity: 0.8
            }),
            onEachFeature: (feature, layer) => layer.bindTooltip(createPopupContent(feature.properties, 'freeze'))
        });
        
        chillLayer = L.geoJson(chillData, {
            style: feature => ({
                fillColor: getColor(feature.properties.first_foliage_chill_median, chillMin, chillMax),
                weight: 1, opacity: 1, color: 'black', dashArray: '0', fillOpacity: 0.8
            }),
            onEachFeature: (feature, layer) => layer.bindTooltip(createPopupContent(feature.properties, 'chill'))
        });

        // Add initial layer and update legend
        chillLayer.addTo(map);
        legend.update('chill');

    }).catch(error => console.error("Failed to load map data:", error));


    // --- Event Listener for the dropdown ---
    document.getElementById('layer-select').addEventListener('change', function(e) {
        const selectedLayer = e.target.value;

        // Remove current layer
        if (map.hasLayer(frostLayer)) map.removeLayer(frostLayer);
        if (map.hasLayer(freezeLayer)) map.removeLayer(freezeLayer);
        if (map.hasLayer(chillLayer)) map.removeLayer(chillLayer);
        

        // Add new layer and update legend
        if (selectedLayer === 'frost') {
            map.addLayer(frostLayer);
            legend.update('frost');
        } else if (selectedLayer === 'freeze') {
            map.addLayer(freezeLayer);
            legend.update('freeze');
        } else if (selectedLayer === 'chill') {
            map.addLayer(chillLayer);
            legend.update('chill');
        }

        currentLayer = selectedLayer;
    });

</script>

</body>
</html>
